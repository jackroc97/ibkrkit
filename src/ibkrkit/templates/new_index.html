<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ strategy_name }} - Strategy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script type="text/javascript" src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        /* Medium+ (md, lg): fixed viewport, no body scroll */
        @media (min-width: 768px) {
            body {
                overflow: hidden;
            }
            .app-wrapper {
                height: 100vh;
            }
            .main-content {
                height: calc(100vh - var(--header-height));
                overflow: hidden;
            }
            .chart-section {
                height: 100%;
                overflow: hidden;
                border-right: 1px solid var(--bs-border-color);
            }
            .data-section {
                height: 100%;
                overflow-y: auto;
            }
        }

        /* Mobile: single scrolling column with 4:3 aspect ratio on chart */
        @media (max-width: 767.98px) {
            .chart-section {
                aspect-ratio: 4 / 3;
                border-bottom: 1px solid var(--bs-border-color);
            }
        }

        /* Header bottom border */
        header {
            border-bottom: 1px solid var(--bs-border-color);
        }

        table th {
            font-size: 0.8rem;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #198754;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body>
    <div class="d-flex flex-column app-wrapper">
        <!-- Header Section -->
        <header class="px-3 py-2 row">
            <h4 class="col-8">
                {{ strategy_name }}<br>
                <small class="text-muted fw-light">Version {{ strategy_version }}</small>
            </h4>
            <div class="col-4 my-auto text-end">
                <span id="status-badge" class="badge fs-6 {% if state == 'Live' %}text-bg-success{% elif state == 'Sleep' %}text-bg-warning{% else %}text-bg-danger{% endif %} my-auto text-uppercase">{{ state }}</span>
            </div>
        </header>

        <!-- Main Content Row -->
        <div class="row g-0 flex-grow-1 main-content">
            <!-- Chart Section: 2/3 width on lg+, 1/2 width on md, full width on mobile -->
            <div class="col-12 col-md-6 col-lg-8 p-0 chart-section">
                <div id="chart-container" class="w-100 h-100"></div>
            </div>

            <!-- Data Section: 1/3 width on lg+, 1/2 width on md, full width on mobile -->
            <div class="col-12 col-md-6 col-lg-4 p-3 data-section">

                <h5 class="mb-3">Positions</h5>
                <div id="positions-container" class="card overflow-hidden mb-3">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="py-1 text-secondary text-left text-uppercase" colspan="3">Position / Symbol</th>
                                <th class="py-1 text-secondary text-center text-uppercase text-nowrap">Entry Price</th>
                                <th class="py-1 text-secondary text-end text-uppercase">PnL</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            {% if positions %}
                                {% for pos in positions %}
                                <tr>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        <span class="badge bg-secondary">{% if pos.quantity < 0 %}ST{% else %}LG{% endif %}</span>
                                    </td>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">{{ pos.quantity|abs }}</td>
                                    <td class="text-left {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">{{ pos.description }}</td>
                                    <td class="text-center text-nowrap {% if loop.last %}border-bottom-0{% endif %}">{{ "%.2f"|format(pos.avg_cost|abs) }} {% if pos.is_credit %}cr{% else %}db{% endif %}</td>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}">
                                        <span class="{% if pos.pnl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold text-uppercase">${{ "%.2f"|format(pos.pnl|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No positions at this time</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <h5 class="mb-3">Open Orders</h5>
                <div id="orders-container" class="card overflow-hidden mb-3">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="py-1 text-secondary text-left text-uppercase" colspan="3">Action / Qty / Symbol</th>
                                <th class="py-1 text-secondary text-center text-uppercase text-nowrap">Lmt Price</th>
                                <th class="py-1 text-secondary text-end text-uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="orders-body">
                            {% if orders %}
                                {% for order in orders %}
                                <tr>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in order.legs %}
                                        <span class="badge bg-secondary">{{ leg.action }}</span>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in order.legs %}
                                        {{ leg.quantity }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-left align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">
                                        {% for leg in order.legs %}
                                        {{ leg.description }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-center align-middle text-nowrap {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if order.limit_price %}{{ "%.2f"|format(order.limit_price|abs) }} {% if order.is_credit %}cr{% else %}db{% endif %}{% endif %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}">
                                        <span class="text-secondary fw-bold text-uppercase">{{ order.status }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No open orders at this time</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <h5 class="mb-3">Filled Orders</h5>
                <div id="trades-container" class="card overflow-hidden mb-3">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="py-1 text-secondary text-left text-uppercase" colspan="3">Action / Qty / Symbol</th>
                                <th class="py-1 text-secondary text-center text-uppercase text-nowrap">Fill Price</th>
                                <th class="py-1 text-secondary text-end text-uppercase">PnL</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                            {% if trades %}
                                {% for trade in trades %}
                                <tr>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in trade.legs %}
                                        <span class="badge bg-secondary">{{ leg.action }}</span>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in trade.legs %}
                                        {{ leg.quantity }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-left align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">
                                        {% for leg in trade.legs %}
                                        {{ leg.description }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-center align-middle text-nowrap {% if loop.last %}border-bottom-0{% endif %}">
                                        {{ "%.2f"|format(trade.fill_price|abs) }} {% if trade.is_credit %}cr{% else %}db{% endif %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if trade.pnl is none %}
                                        <span class="text-secondary fw-bold text-uppercase">Open</span>
                                        {% elif trade.pnl >= 0 %}
                                        <span class="text-success fw-bold text-uppercase">${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                        {% else %}
                                        <span class="text-danger fw-bold text-uppercase">${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No filled orders in this session</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Live Indicator -->
                <div class="text-center text-secondary small mt-3">
                    <span class="live-indicator"></span>Live updates | Last: <span id="last-updated">{{ last_updated }}</span>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    // Chart initialization (placeholder for now)
    document.addEventListener('DOMContentLoaded', function() {
        const styles = getComputedStyle(document.body);
        const bgColor = styles.getPropertyValue('--bs-body-bg').trim() || '#212529';
        const borderColor = styles.getPropertyValue('--bs-border-color').trim() || '#495057';

        const chartContainer = document.getElementById('chart-container');
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { type: 'solid', color: bgColor },
                textColor: '#dee2e6',
            },
            grid: {
                vertLines: { color: borderColor },
                horzLines: { color: borderColor },
            },
            rightPriceScale: {
                borderColor: borderColor,
            },
            timeScale: {
                borderColor: borderColor,
            },
        });

        // Placeholder data
        const candleStickData = [];
        let basePrice = 6000;
        let currentDate = new Date('2024-12-01');

        for (let i = 0; i < 60; i++) {
            const open = basePrice + (Math.random() - 0.5) * 20;
            const close = open + (Math.random() - 0.5) * 30;
            const high = Math.max(open, close) + Math.random() * 15;
            const low = Math.min(open, close) - Math.random() * 15;

            candleStickData.push({
                time: currentDate.toISOString().split('T')[0],
                open: parseFloat(open.toFixed(2)),
                high: parseFloat(high.toFixed(2)),
                low: parseFloat(low.toFixed(2)),
                close: parseFloat(close.toFixed(2)),
            });

            basePrice = close + (Math.random() - 0.48) * 10;
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const mainSeries = chart.addSeries(LightweightCharts.CandlestickSeries);
        mainSeries.setData(candleStickData);

        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const { width, height } = entry.contentRect;
                chart.resize(width, height);
            }
        });
        resizeObserver.observe(chartContainer);
    });

    // Live updates via Server-Sent Events
    function updateStatus(state) {
        const badge = document.getElementById('status-badge');
        badge.textContent = state;
        badge.className = 'badge fs-6 my-auto text-uppercase ';
        if (state === 'Live') {
            badge.classList.add('text-bg-success');
        } else if (state === 'Sleep') {
            badge.classList.add('text-bg-warning');
        } else {
            badge.classList.add('text-bg-danger');
        }
    }

    function renderPositions(positions) {
        const tbody = document.getElementById('positions-body');
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No positions at this time</td></tr>';
            return;
        }
        let html = '';
        positions.forEach((pos, index) => {
            const isLast = index === positions.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const posType = pos.quantity < 0 ? 'ST' : 'LG';
            const pnlClass = pos.pnl >= 0 ? 'text-success' : 'text-danger';
            const crDb = pos.is_credit ? 'cr' : 'db';
            html += `<tr>
                <td class="text-end ${borderClass}" style="width: 0px"><span class="badge bg-secondary">${posType}</span></td>
                <td class="text-end ${borderClass}" style="width: 0px">${Math.abs(pos.quantity)}</td>
                <td class="text-left ${borderClass}" style="width: 50%">${pos.description}</td>
                <td class="text-center text-nowrap ${borderClass}">${Math.abs(pos.avg_cost).toFixed(2)} ${crDb}</td>
                <td class="text-end ${borderClass}"><span class="${pnlClass} fw-bold text-uppercase">$${Math.abs(pos.pnl).toFixed(2)}</span></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function renderOrders(orders) {
        const tbody = document.getElementById('orders-body');
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No open orders at this time</td></tr>';
            return;
        }
        let html = '';
        orders.forEach((order, index) => {
            const isLast = index === orders.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const crDb = order.is_credit ? 'cr' : 'db';

            const actionsHtml = order.legs.map(leg => `<span class="badge bg-secondary">${leg.action}</span>`).join('<br>');
            const qtysHtml = order.legs.map(leg => leg.quantity).join('<br>');
            const descsHtml = order.legs.map(leg => leg.description).join('<br>');
            const priceHtml = order.limit_price ? `${Math.abs(order.limit_price).toFixed(2)} ${crDb}` : '';

            html += `<tr>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${actionsHtml}</td>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${qtysHtml}</td>
                <td class="text-left align-middle ${borderClass}" style="width: 50%">${descsHtml}</td>
                <td class="text-center align-middle text-nowrap ${borderClass}">${priceHtml}</td>
                <td class="text-end align-middle ${borderClass}"><span class="text-secondary fw-bold text-uppercase">${order.status}</span></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function renderTrades(trades) {
        const tbody = document.getElementById('trades-body');
        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No filled orders in this session</td></tr>';
            return;
        }
        let html = '';
        trades.forEach((trade, index) => {
            const isLast = index === trades.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const crDb = trade.is_credit ? 'cr' : 'db';

            const actionsHtml = trade.legs.map(leg => `<span class="badge bg-secondary">${leg.action}</span>`).join('<br>');
            const qtysHtml = trade.legs.map(leg => leg.quantity).join('<br>');
            const descsHtml = trade.legs.map(leg => leg.description).join('<br>');

            let pnlHtml;
            if (trade.pnl === null) {
                pnlHtml = '<span class="text-secondary fw-bold text-uppercase">Open</span>';
            } else if (trade.pnl >= 0) {
                pnlHtml = `<span class="text-success fw-bold text-uppercase">$${Math.abs(trade.pnl).toFixed(2)}</span>`;
            } else {
                pnlHtml = `<span class="text-danger fw-bold text-uppercase">$${Math.abs(trade.pnl).toFixed(2)}</span>`;
            }

            html += `<tr>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${actionsHtml}</td>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${qtysHtml}</td>
                <td class="text-left align-middle ${borderClass}" style="width: 50%">${descsHtml}</td>
                <td class="text-center align-middle text-nowrap ${borderClass}">${Math.abs(trade.fill_price).toFixed(2)} ${crDb}</td>
                <td class="text-end align-middle ${borderClass}">${pnlHtml}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // Connect to Server-Sent Events for live updates
    const eventSource = new EventSource('/events');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateStatus(data.state);
        renderPositions(data.positions);
        renderOrders(data.orders);
        renderTrades(data.trades);
        document.getElementById('last-updated').textContent = data.last_updated;
    };

    eventSource.onerror = function() {
        console.log('SSE connection lost, will retry...');
    };
</script>
</html>
