<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" style="overflow-x: hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ strategy_name }} - Strategy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --lwc-up-color: #26a69a;
            --lwc-down-color: #ef5350;
        }

        html, body {
            height: 100%;
            margin: 0;
        }

        /* Medium+ (md, lg): fixed viewport, no body scroll */
        @media (min-width: 768px) {
            body {
                overflow: hidden;
            }
            .app-wrapper {
                height: 100vh;
            }
            .main-content {
                height: calc(100vh - var(--header-height));
                overflow: hidden;
            }
            .chart-section {
                height: 100%;
                overflow: hidden;
                border-right: 1px solid var(--bs-border-color);
            }
            .data-section {
                height: 100%;
                overflow-y: auto;
            }
        }

        /* Mobile: single scrolling column with 4:3 aspect ratio on chart */
        @media (max-width: 767.98px) {
            .chart-section {
                aspect-ratio: 4 / 3;
                border-bottom: 1px solid var(--bs-border-color);
            }
        }

        /* Header bottom border */
        header {
            border-bottom: 1px solid var(--bs-border-color);
        }

        table th {
            font-size: 0.8rem;
        }

        #chart-last-price {
            transition: color 0.15s ease-out;
        }

        /* Bid/Ask flash transition */
        [id^="order-bidask-"] {
            transition: color 0.15s ease-out;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--lwc-up-color);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        /* LWC color utility classes */
        .text-lwc-up { color: var(--lwc-up-color) !important; }
        .text-lwc-down { color: var(--lwc-down-color) !important; }

        /* LWC badge background colors for status indicator */
        .badge-lwc-up { background-color: var(--lwc-up-color) !important; color: #fff !important; }
        .badge-lwc-down { background-color: var(--lwc-down-color) !important; color: #fff !important; }

        /* Ensure dropdown menu appears above chart */
        .dropdown-menu {
            z-index: 1050;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <div class="d-flex flex-column app-wrapper">
        <!-- Header Section -->
        <header class="px-3 py-2 row">
            <div class="h4 my-0 col-8">
                {{ strategy_name }} <small class="text-muted fw-light">Version {{ strategy_version }}</small>
            </div>
            <div class="col-4 my-auto text-end">
                <span id="status-badge" class="badge fs-6 {% if state == 'Live' %}badge-lwc-up{% elif state == 'Sleep' %}text-bg-warning{% else %}badge-lwc-down{% endif %} my-auto text-uppercase">{{ state }}</span>
            </div>
        </header>

        <!-- Main Content Row -->
        <div class="row g-0 flex-grow-1 main-content">
            <!-- Chart Section: 2/3 width on lg+, 1/2 width on md, full width on mobile -->
            <div class="col-12 col-md-6 col-lg-8 p-0 d-flex flex-column chart-section">
                <div class="px-3 py-2 border-bottom d-flex align-items-center">
                    <div class="dropdown overflow-hidden">
                      <button id="chart-contract-btn" class="btn btn-secondary dropdown-toggle w-100 text-truncate" type="button" data-bs-toggle="dropdown" data-bs-popper-config='{"strategy":"fixed"}' aria-expanded="false">
                        Select Contract
                      </button>
                      <ul id="chart-contract-menu" class="dropdown-menu dropdown-menu-dark">
                        <!-- Populated dynamically from chart_contracts -->
                      </ul>
                    </div>

                    <div id="chart-last-price" class="h4 ms-3 my-0 d-flex align-items-center">
                        <span id="chart-price-value" class="fw-bold">--</span>
                        <span id="chart-price-pct" class="ms-2" style="font-size: 0.7em;"></span>
                    </div>
                </div>
                <div id="chart-container" class="w-100 h-100"></div>
            </div>

            <!-- Data Section: 1/3 width on lg+, 1/2 width on md, full width on mobile -->
            <div class="col-12 col-md-6 col-lg-4 p-3 data-section">

                <h5 class="mb-3">Positions</h5>
                <div id="positions-container" class="card overflow-hidden mb-3 overflow-x-auto">
                    <table class="table mb-0 text-nowrap">
                        <thead>
                            <tr>
                                <th class="py-1 bg-light-subtle text-secondary text-left text-uppercase" colspan="3">Position / Symbol</th>
                                <th class="py-1 bg-light-subtle text-secondary text-center text-uppercase text-nowrap">Entry Price</th>
                                <th class="py-1 bg-light-subtle text-secondary text-end text-uppercase">PnL</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            {% if positions %}
                                {% for pos in positions %}
                                <tr>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        <span class="badge bg-secondary">{% if pos.quantity < 0 %}SHO{% else %}LON{% endif %}</span>
                                    </td>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">{{ pos.quantity|abs }}</td>
                                    <td class="text-left {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">{{ pos.description }}</td>
                                    <td class="text-center text-nowrap {% if loop.last %}border-bottom-0{% endif %}">{{ "%.2f"|format(pos.avg_cost|abs) }} {% if pos.is_credit %}cr{% else %}db{% endif %}</td>
                                    <td class="text-end {% if loop.last %}border-bottom-0{% endif %}">
                                        <span class="{% if pos.pnl >= 0 %}text-lwc-up{% else %}text-lwc-down{% endif %} fw-bold text-uppercase">${{ "%.2f"|format(pos.pnl|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No positions at this time</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <h5 class="mb-3">Open Orders</h5>
                <div id="orders-container" class="card overflow-hidden mb-3 overflow-x-auto">
                    <table class="table mb-0 text-nowrap">
                        <thead>
                            <tr>
                                <th class="py-1 text-secondary bg-light-subtle text-left text-uppercase" colspan="3">Action / Qty / Symbol</th>
                                <th class="py-1 text-secondary bg-light-subtle text-center text-uppercase text-nowrap">Lmt Price</th>
                                <th class="py-1 text-secondary bg-light-subtle text-end text-uppercase">Bid/Ask</th>
                            </tr>
                        </thead>
                        <tbody id="orders-body">
                            {% if orders %}
                                {% for order in orders %}
                                <tr>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in order.legs %}
                                        <span class="badge bg-secondary">{{ leg.action }}</span>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in order.legs %}
                                        {{ leg.quantity }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-left align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">
                                        {% for leg in order.legs %}
                                        {{ leg.description }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-center align-middle text-nowrap {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if order.limit_price %}{{ "%.2f"|format(order.limit_price|abs) }} {% if order.is_credit %}cr{% else %}db{% endif %}{% endif %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if order.bid is not none and order.ask is not none %}
                                        <span class="text-secondary fw-bold">{{ "%.2f"|format(order.bid) }} / {{ "%.2f"|format(order.ask) }}</span>
                                        {% else %}
                                        <span class="text-secondary fw-bold">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No open orders at this time</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <h5 class="mb-3">Filled Orders</h5>
                <div id="trades-container" class="card overflow-hidden mb-3 overflow-x-auto">
                    <table class="table mb-0 text-nowrap">
                        <thead>
                            <tr>
                                <th class="py-1 bg-light-subtle text-secondary text-left text-uppercase" colspan="3">Action / Qty / Symbol</th>
                                <th class="py-1 bg-light-subtle text-secondary text-center text-uppercase text-nowrap">Fill Price</th>
                                <th class="py-1 bg-light-subtle text-secondary text-end text-uppercase">PnL</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                            {% if trades %}
                                {% for trade in trades %}
                                <tr>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in trade.legs %}
                                        <span class="badge bg-secondary">{{ leg.action }}</span>{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 0px">
                                        {% for leg in trade.legs %}
                                        {{ leg.quantity }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-left align-middle {% if loop.last %}border-bottom-0{% endif %}" style="width: 50%">
                                        {% for leg in trade.legs %}
                                        {{ leg.description }}{% if not loop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-center align-middle text-nowrap {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if trade.is_expiration %}-.-- db{% else %}{{ "%.2f"|format(trade.fill_price|abs) }} {% if trade.is_credit %}cr{% else %}db{% endif %}{% endif %}
                                    </td>
                                    <td class="text-end align-middle {% if loop.last %}border-bottom-0{% endif %}">
                                        {% if trade.is_expiration and trade.pnl is none %}
                                        <span class="text-secondary fw-bold text-uppercase">UNKWN</span>
                                        {% elif trade.pnl is none %}
                                        <span class="text-secondary fw-bold text-uppercase">N/A</span>
                                        {% elif trade.pnl >= 0 %}
                                        <span class="text-lwc-up fw-bold text-uppercase">${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                        {% else %}
                                        <span class="text-lwc-down fw-bold text-uppercase">${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-secondary border-bottom-0">No filled orders in this session</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Live Indicator -->
                <div class="text-center text-secondary small mt-3">
                    <span class="live-indicator"></span>Live updates | Last: <span id="last-updated">{{ last_updated }}</span>
                </div>
            </div>
        </div>
    </div>
</body>
<script>

    // Chart initialization
    let chart = null;
    let mainSeries = null;
    let volumeSeries = null;
    let currentChartConId = null;
    let currentChartLabel = null;
    let currentChartIsUnderlying = false;
    let chartContractsCache = [];
    let breakEvenLines = [];  // Track price lines for removal when switching contracts
    let lastDisplayedPrice = null;  // Track previous price for flash animation
    let dayStartPrice = null;  // Track the first bar's open price for percentage calculation
    let previousOrderBidAsks = {};  // Track previous bid/ask values for flash animation (keyed by order index)

    document.addEventListener('DOMContentLoaded', function() {
        console.log('[DEBUG] DOMContentLoaded fired');
        const styles = getComputedStyle(document.body);
        const bgColor = styles.getPropertyValue('--bs-body-bg').trim() || '#212529';
        const borderColor = styles.getPropertyValue('--bs-border-color').trim() || '#495057';

        const chartContainer = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { type: 'solid', color: bgColor },
                textColor: '#dee2e6',
                attributionLogo: false,
            },
            grid: {
                vertLines: { color: borderColor },
                horzLines: { color: borderColor },
            },
            rightPriceScale: {
                borderColor: borderColor,
            },
            timeScale: {
                borderColor: borderColor,
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Use LightweightCharts default colors
        const lwcUpColor = getComputedStyle(document.documentElement).getPropertyValue('--lwc-up-color').trim();
        const lwcDownColor = getComputedStyle(document.documentElement).getPropertyValue('--lwc-down-color').trim();

        mainSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: lwcUpColor,
            downColor: lwcDownColor,
            borderUpColor: lwcUpColor,
            borderDownColor: lwcDownColor,
            wickUpColor: lwcUpColor,
            wickDownColor: lwcDownColor,
        });

        // Add volume histogram series with its own price scale
        volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
            priceFormat: {
                type: 'volume',
            },
            priceScaleId: 'volume',
        });

        // Configure the volume price scale (on the left, smaller)
        chart.priceScale('volume').applyOptions({
            scaleMargins: {
                top: 0.8,  // Volume takes up bottom 20% of chart
                bottom: 0,
            },
            borderVisible: false,
        });

        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const { width, height } = entry.contentRect;
                chart.resize(width, height);
            }
        });
        resizeObserver.observe(chartContainer);

        // Load initial chart data - prefer underlying contracts over options
        const chartContracts = {{ chart_contracts | tojson }};
        updateChartDropdown(chartContracts);
        if (chartContracts && chartContracts.length > 0) {
            // Find first underlying, or fall back to first contract
            const underlying = chartContracts.find(c => c.isUnderlying);
            const contractToLoad = underlying || chartContracts[0];
            selectChartContract(contractToLoad.conId, contractToLoad.label, contractToLoad.isUnderlying);
        }

        // Refresh chart data periodically (every 5 seconds)
        setInterval(() => {
            if (currentChartConId) {
                loadChartData(currentChartConId);
            }
        }, 5000);

        // Set up dropdown click handler using event delegation
        const chartMenu = document.getElementById('chart-contract-menu');
        if (chartMenu) {
            console.log('[Chart] Setting up dropdown click handler');
            chartMenu.addEventListener('click', function(e) {
                console.log('[Chart] Menu clicked, target:', e.target);
                const item = e.target.closest('.dropdown-item');
                if (item && item.dataset.conid) {
                    e.preventDefault();
                    const conId = parseInt(item.dataset.conid);
                    const label = item.dataset.label;
                    const isUnderlying = item.dataset.isunderlying === 'true';
                    console.log('[Chart] Dropdown item clicked - conId:', conId, 'label:', label, 'isUnderlying:', isUnderlying);
                    selectChartContract(conId, label, isUnderlying);
                }
            });
        } else {
            console.log('[Chart] ERROR: chart-contract-menu not found');
        }
    });

    function updateChartDropdown(contracts) {
        chartContractsCache = contracts || [];
        const menu = document.getElementById('chart-contract-menu');
        if (!menu) return;

        if (!contracts || contracts.length === 0) {
            menu.innerHTML = '<li><span class="dropdown-item text-muted">No contracts available</span></li>';
            return;
        }

        let html = '';
        contracts.forEach(contract => {
            const isActive = contract.conId === currentChartConId ? 'active' : '';
            const typeLabel = contract.isUnderlying ? '' : ' (Option)';
            html += `<li><a class="dropdown-item ${isActive}" href="#" data-conid="${contract.conId}" data-label="${contract.label}" data-isunderlying="${contract.isUnderlying}">${contract.label}${typeLabel}</a></li>`;
        });
        menu.innerHTML = html;
    }

    function selectChartContract(conId, label, isUnderlying = null) {
        console.log('[Chart] selectChartContract called - conId:', conId, 'label:', label, 'isUnderlying:', isUnderlying);
        currentChartConId = conId;
        currentChartLabel = label;
        lastDisplayedPrice = null;  // Reset so first load doesn't flash
        dayStartPrice = null;  // Reset day start price for new contract

        // Determine if this is an underlying from the cache if not provided
        if (isUnderlying === null) {
            const contract = chartContractsCache.find(c => c.conId === conId);
            currentChartIsUnderlying = contract ? contract.isUnderlying : false;
        } else {
            currentChartIsUnderlying = isUnderlying;
        }

        // Update button text
        const btn = document.getElementById('chart-contract-btn');
        if (btn) {
            btn.textContent = label;
        }

        // Update active state in dropdown
        const menu = document.getElementById('chart-contract-menu');
        if (menu) {
            menu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.conid) === conId) {
                    item.classList.add('active');
                }
            });
        }

        // Load the chart data
        loadChartData(conId);
    }

    function clearBreakEvenLines() {
        // Remove all existing breakeven price lines from the series
        breakEvenLines.forEach(line => {
            try {
                mainSeries.removePriceLine(line);
            } catch (e) {
                // Line may already be removed
            }
        });
        breakEvenLines = [];
    }

    async function loadBreakEvens(conId) {
        // Only load breakevens for underlying charts
        if (!currentChartIsUnderlying) {
            clearBreakEvenLines();
            return;
        }

        try {
            const response = await fetch(`/breakevens/${conId}`);
            const data = await response.json();
            console.log('[Chart] Received', data ? data.length : 0, 'breakevens for conId', conId);

            // Clear existing lines first
            clearBreakEvenLines();

            // Add new breakeven lines
            if (data && data.length > 0 && mainSeries) {
                data.forEach(be => {
                    const line = mainSeries.createPriceLine({
                        price: be.price,
                        color: '#2196F3',  // Blue
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Solid,
                        axisLabelVisible: true,
                        title: be.label,
                    });
                    breakEvenLines.push(line);
                });
            }
        } catch (error) {
            console.error('Error loading breakevens:', error);
        }
    }

    async function loadChartData(conId) {
        console.log('[Chart] loadChartData called for conId:', conId);
        try {
            const response = await fetch(`/chart_data/${conId}`);
            const data = await response.json();
            console.log('[Chart] Received', data ? data.length : 0, 'bars for conId', conId);
            if (data && data.length > 0 && mainSeries) {
                mainSeries.setData(data);

                // Set volume data with color based on price direction
                if (volumeSeries) {
                    const lwcUpColor = getComputedStyle(document.documentElement).getPropertyValue('--lwc-up-color').trim();
                    const lwcDownColor = getComputedStyle(document.documentElement).getPropertyValue('--lwc-down-color').trim();
                    const volumeData = data.map(bar => ({
                        time: bar.time,
                        value: bar.volume || 0,
                        color: bar.close >= bar.open ? lwcUpColor : lwcDownColor,
                    }));
                    volumeSeries.setData(volumeData);
                }

                chart.timeScale().fitContent();

                // Update last price display with flash animation and percentage
                const lastBar = data[data.length - 1];
                const firstBar = data[0];
                const priceValueEl = document.getElementById('chart-price-value');
                const pricePctEl = document.getElementById('chart-price-pct');

                if (priceValueEl && lastBar) {
                    const newPrice = lastBar.close;

                    // Set day start price from first bar's open (only on first load for this contract)
                    if (dayStartPrice === null && firstBar) {
                        dayStartPrice = firstBar.open;
                    }

                    // Update price display
                    priceValueEl.textContent = newPrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                    // Flash animation based on price change
                    if (lastDisplayedPrice !== null && newPrice !== lastDisplayedPrice) {
                        const flashClass = newPrice > lastDisplayedPrice ? 'text-lwc-up' : 'text-lwc-down';
                        priceValueEl.classList.add(flashClass);
                        setTimeout(() => {
                            priceValueEl.classList.remove(flashClass);
                        }, 300);
                    }
                    lastDisplayedPrice = newPrice;

                    // Update percentage display
                    if (pricePctEl && dayStartPrice !== null && dayStartPrice !== 0) {
                        const pctChange = ((newPrice - dayStartPrice) / dayStartPrice) * 100;
                        const pctSign = pctChange >= 0 ? '+' : '';
                        pricePctEl.textContent = `(${pctSign}${pctChange.toFixed(2)}%)`;
                        pricePctEl.className = 'ms-2 ' + (pctChange >= 0 ? 'text-lwc-up' : 'text-lwc-down');
                        pricePctEl.style.fontSize = '0.7em';
                    }
                }

                // Load breakevens for underlying charts
                await loadBreakEvens(conId);
            } else {
                console.log('[Chart] No data or mainSeries not ready');
                // Still try to clear breakeven lines if switching to a contract with no data
                clearBreakEvenLines();
            }
        } catch (error) {
            console.error('Error loading chart data:', error);
        }
    }

    // Live updates via Server-Sent Events
    function updateStatus(state) {
        const badge = document.getElementById('status-badge');
        badge.textContent = state;
        badge.className = 'badge fs-6 my-auto text-uppercase ';
        if (state === 'Live') {
            badge.classList.add('badge-lwc-up');
        } else if (state === 'Sleep') {
            badge.classList.add('text-bg-warning');
        } else {
            badge.classList.add('badge-lwc-down');
        }
    }

    function renderPositions(positions) {
        const tbody = document.getElementById('positions-body');
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No positions at this time</td></tr>';
            return;
        }
        let html = '';
        positions.forEach((pos, index) => {
            const isLast = index === positions.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const posType = pos.quantity < 0 ? 'SHO' : 'LON';
            const pnlClass = pos.pnl >= 0 ? 'text-lwc-up' : 'text-lwc-down';
            const crDb = pos.is_credit ? 'cr' : 'db';
            html += `<tr>
                <td class="text-end ${borderClass}" style="width: 0px"><span class="badge bg-secondary">${posType}</span></td>
                <td class="text-end ${borderClass}" style="width: 0px">${Math.abs(pos.quantity)}</td>
                <td class="text-left ${borderClass}" style="width: 50%">${pos.description}</td>
                <td class="text-center text-nowrap ${borderClass}">${Math.abs(pos.avg_cost).toFixed(2)} ${crDb}</td>
                <td class="text-end ${borderClass}"><span class="${pnlClass} fw-bold text-uppercase">$${Math.abs(pos.pnl).toFixed(2)}</span></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function renderOrders(orders) {
        const tbody = document.getElementById('orders-body');
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No open orders at this time</td></tr>';
            previousOrderBidAsks = {};
            return;
        }

        // Build a key for each order based on its description (to track bid/ask changes)
        const newBidAsks = {};

        let html = '';
        orders.forEach((order, index) => {
            const isLast = index === orders.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const crDb = order.is_credit ? 'cr' : 'db';

            const actionsHtml = order.legs.map(leg => `<span class="badge bg-secondary">${leg.action}</span>`).join('<br>');
            const qtysHtml = order.legs.map(leg => leg.quantity).join('<br>');
            const descsHtml = order.legs.map(leg => leg.description).join('<br>');
            const priceHtml = order.limit_price ? `${Math.abs(order.limit_price).toFixed(2)} ${crDb}` : '';

            // Create unique key for this order based on legs description
            const orderKey = order.legs.map(leg => leg.description).join('|');

            // Build bid/ask display showing both values
            let bidAskHtml;
            if (order.bid !== null && order.bid !== undefined && order.ask !== null && order.ask !== undefined) {
                const bidValue = order.bid.toFixed(2);
                const askValue = order.ask.toFixed(2);
                const midpoint = (order.bid + order.ask) / 2;
                newBidAsks[orderKey] = midpoint;

                // Check for flash animation based on midpoint change
                const prevMidpoint = previousOrderBidAsks[orderKey];
                let flashClass = '';
                if (prevMidpoint !== undefined && prevMidpoint !== midpoint) {
                    flashClass = midpoint > prevMidpoint ? 'text-lwc-up' : 'text-lwc-down';
                }

                bidAskHtml = `<span id="order-bidask-${index}" class="fw-bold ${flashClass || 'text-secondary'}">${bidValue} / ${askValue}</span>`;
            } else {
                bidAskHtml = '<span class="text-secondary fw-bold">--</span>';
            }

            html += `<tr>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${actionsHtml}</td>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${qtysHtml}</td>
                <td class="text-left align-middle ${borderClass}" style="width: 50%">${descsHtml}</td>
                <td class="text-center align-middle text-nowrap ${borderClass}">${priceHtml}</td>
                <td class="text-end align-middle ${borderClass}">${bidAskHtml}</td>
            </tr>`;
        });
        tbody.innerHTML = html;

        // Schedule removal of flash classes after animation
        orders.forEach((order, index) => {
            if (order.bid !== null && order.bid !== undefined && order.ask !== null && order.ask !== undefined) {
                const orderKey = order.legs.map(leg => leg.description).join('|');
                const midpoint = (order.bid + order.ask) / 2;
                const prevMidpoint = previousOrderBidAsks[orderKey];
                if (prevMidpoint !== undefined && prevMidpoint !== midpoint) {
                    const el = document.getElementById(`order-bidask-${index}`);
                    if (el) {
                        setTimeout(() => {
                            el.classList.remove('text-lwc-up', 'text-lwc-down');
                            el.classList.add('text-secondary');
                        }, 300);
                    }
                }
            }
        });

        // Update previous bid/ask tracking
        previousOrderBidAsks = newBidAsks;
    }

    function renderTrades(trades) {
        const tbody = document.getElementById('trades-body');
        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary border-bottom-0">No filled orders in this session</td></tr>';
            return;
        }
        let html = '';
        trades.forEach((trade, index) => {
            const isLast = index === trades.length - 1;
            const borderClass = isLast ? 'border-bottom-0' : '';
            const crDb = trade.is_credit ? 'cr' : 'db';

            const actionsHtml = trade.legs.map(leg => `<span class="badge bg-secondary">${leg.action}</span>`).join('<br>');
            const qtysHtml = trade.legs.map(leg => leg.quantity).join('<br>');
            const descsHtml = trade.legs.map(leg => leg.description).join('<br>');

            let pnlHtml;
            if (trade.is_expiration && trade.pnl === null) {
                pnlHtml = '<span class="text-secondary fw-bold text-uppercase">UNKWN</span>';
            } else if (trade.pnl === null) {
                pnlHtml = '<span class="text-secondary fw-bold text-uppercase">N/A</span>';
            } else if (trade.pnl >= 0) {
                pnlHtml = `<span class="text-lwc-up fw-bold text-uppercase">$${Math.abs(trade.pnl).toFixed(2)}</span>`;
            } else {
                pnlHtml = `<span class="text-lwc-down fw-bold text-uppercase">$${Math.abs(trade.pnl).toFixed(2)}</span>`;
            }

            const fillPriceHtml = trade.is_expiration ? '-.-- db' : `${Math.abs(trade.fill_price).toFixed(2)} ${crDb}`;

            html += `<tr>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${actionsHtml}</td>
                <td class="text-end align-middle ${borderClass}" style="width: 0px">${qtysHtml}</td>
                <td class="text-left align-middle ${borderClass}" style="width: 50%">${descsHtml}</td>
                <td class="text-center align-middle text-nowrap ${borderClass}">${fillPriceHtml}</td>
                <td class="text-end align-middle ${borderClass}">${pnlHtml}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // Connect to Server-Sent Events for live updates
    const eventSource = new EventSource('/events');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateStatus(data.state);
        renderPositions(data.positions);
        renderOrders(data.orders);
        renderTrades(data.trades);
        document.getElementById('last-updated').textContent = data.last_updated;

        // Update the chart contract dropdown
        if (data.chart_contracts) {
            updateChartDropdown(data.chart_contracts);
        }

        // Load chart data if we don't have one yet and contracts are available
        if (!currentChartConId && data.chart_contracts && data.chart_contracts.length > 0) {
            const underlying = data.chart_contracts.find(c => c.isUnderlying);
            const contractToLoad = underlying || data.chart_contracts[0];
            selectChartContract(contractToLoad.conId, contractToLoad.label, contractToLoad.isUnderlying);
        }
    };

    eventSource.onerror = function() {
        console.log('SSE connection lost, will retry...');
    };
</script>
</html>
